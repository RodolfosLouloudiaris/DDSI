{% extends "base.html" %}
{% block content %}

<h2>Create New Order</h2>

<form method="post" id="orderForm">

    <!-- CUSTOMER -->
    <label>Customer:</label><br>
    <select name="customer_id" required>
        {% for c in customers %}
            <option value="{{ c.customer_id }}">{{ c.first_name }} {{ c.last_name }}</option>
        {% endfor %}
    </select><br><br>

    <h3>Order Items</h3>

    <table id="itemsTable" border="1" cellpadding="6">
        <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Subtotal</th>
            <th></th>
        </tr>
    </table>

    <button type="button" onclick="addItem()">➕ Add Item</button>

    <h3>Total: € <span id="total">0.00</span></h3>

    <br>
    <button type="submit">Create Order</button>
</form>


<script>
let products = JSON.parse('{{ products|tojson|safe }}');

function addItem() {
    let table = document.getElementById("itemsTable");
    let row = table.insertRow();

    let productOptions = products.map(p =>
        `<option value="${p.product_id}" data-price="${p.price}">${p.name}</option>`
    ).join("");

    row.innerHTML = `
        <td>
            <select name="product_id[]" onchange="updatePrice(this)">
                ${productOptions}
            </select>
        </td>
        <td><input name="quantity[]" type="number" value="1" min="1" onchange="updateTotal()" required></td>
        <td><input name="price[]" type="number" step="0.01" value="0" required></td>
        <td class="subtotal">0.00</td>
        <td><button type="button" onclick="removeRow(this)">❌</button></td>
    `;

    updatePrice(row.querySelector("select"));
}

function updatePrice(selectElem) {
    let price = selectElem.selectedOptions[0].dataset.price;
    let row = selectElem.parentNode.parentNode;

    row.querySelector('input[name="price[]"]').value = price;
    updateSubtotal(row);
    updateTotal();
}

function updateSubtotal(row) {
    let qty = parseFloat(row.querySelector('input[name="quantity[]"]').value);
    let price = parseFloat(row.querySelector('input[name="price[]"]').value);
    row.querySelector(".subtotal").innerText = (qty * price).toFixed(2);
}

function updateTotal() {
    let subtotals = document.querySelectorAll(".subtotal");
    let total = 0;
    subtotals.forEach(s => total += parseFloat(s.innerText));
    document.getElementById("total").innerText = total.toFixed(2);
}

function removeRow(btn) {
    btn.parentNode.parentNode.remove();
    updateTotal();
}
addItem();
</script>

{% endblock %}
